# Hybrid Force/Motion Control for RCM

This document derives the Quadratic Program (QP) formulation for a Hybrid Force/Motion controller subject to a Remote Center of Motion (RCM) constraint.

## 1. Concept

We separate the robot's task space (at the tip) into two orthogonal subspaces:
1.  **Normal Direction ($\hat{n}$):** Controlled by **Force** (via Admittance).
2.  **Tangential Plane ($\hat{t}$):** Controlled by **Motion** (Kinematic Scanning), subject to RCM.

The RCM constraint is a "hard" constraint on the pivot point, while the tip tasks are "soft" objectives in the QP cost function.

---


## 2. Definitions

- **$\hat{n}$**: Surface normal vector (Insertion axis, typically Probe Z).
- **$P_n = \hat{n}\hat{n}^\top$**: Projection matrix onto the normal.
- **$P_t = I - P_n$**: Projection matrix onto the tangent plane.
- **$f_{meas}$**: Measured contact force vector on the tip.
- **$f_{des}$**: Desired scalar normal force (positive = compression).

---


## 3. Admittance Law (Force Subspace)

We convert force error into a desired velocity along the normal. Since we control velocity $v$, this is an **Admittance** formulation.

The contact force on the probe during compression is opposite to the surface normal:
$$f_{meas} = -F_{mag} \hat{n}$$

The signed magnitude of the force in the insertion direction is:
$$F_{ins} = f_{meas} \cdot \hat{n} \quad (\text{Expected value: } < 0 \text{ for compression})$$

We define the desired normal velocity $v_{adm}$ to regulate this force:
$$v_{adm} = K_f (F_{ins} - (-f_{des}))$$
* If $|F_{ins}| > f_{des}$ (too much force), $v_{adm}$ becomes negative (retract).
* If $|F_{ins}| < f_{des}$ (too little force), $v_{adm}$ becomes positive (insert).

The spatial velocity command for the force task is:
$$V_{force} = v_{adm} \hat{n}$$

--- 

## 4. Motion Law (Tangent Subspace)

We have a desired scanning twist $V_{scan}$ (linear velocity $v_{scan}$ and angular velocity $\omega_{scan}$) generated by the pivoting logic. We must ensure this motion **only** affects the tangent plane and does not fight the force controller.

$$v_{motion} = P_t \, v_{scan} = v_{scan} - (v_{scan} \cdot \hat{n}) \hat{n}$$

This removes any insertion component from the scanning command.

--- 

## 5. Combined QP Formulation

We solve for joint velocities $v \in \mathbb{R}^6$.

**Decision Variable:** $v$

**Hard Constraints:**
1.  **RCM Constraint:** The shaft must pivot at the trocar.
    $$B_\perp J_P v = 0$$
    (Where $B_\perp$ is the lateral basis at the trocar point $P$).

2.  **Joint Limits:**
    $$v_{min} \le v \le v_{max}$$

**Cost Function:**
We minimize the tracking error for both the **Hybrid Linear Velocity** and the **Scanning Orientation**.

Desired Linear Velocity:
$$v_{cmd}^{lin} = v_{motion} + V_{force}$$

Cost:
$$\min_v \quad || J_{lin} v - v_{cmd}^{lin} ||^2_{W_{lin}} + || J_{roll} v - \omega_{roll} ||^2_{w_{roll}} + \epsilon ||v||^2$$

**Weighting ($W_{lin}$):**
To ensure strict force tracking, we weight the normal direction higher than the tangent direction.
$$W_{lin} = I + (\alpha - 1) \hat{n}\hat{n}^\top$$
where $\alpha \gg 1$ (e.g., 10 or 100). This prioritizes satisfying the admittance command (Force) over the scanning speed (Motion) if they conflict.

---


## 6. Summary of Algorithm

1.  **Estimate Normal:** $\hat{n} = R_{tip} \cdot [0,0,1]^\top$.
2.  **Measure Force:** $F_{ins} = f_{contact} \cdot \hat{n}$.
3.  **Compute Admittance:** $v_{adm} = K_f (F_{ins} + f_{des})$.
4.  **Compute Scan:** Get $v_{scan}$ from pivoting generator.
5.  **Project Scan:** $v_{tan} = v_{scan} - (v_{scan} \cdot \hat{n})\hat{n}$.
6.  **Combine:** $v_{cmd} = v_{tan} + v_{adm} \hat{n}$.
7.  **Prioritize:** Set $W_{lin}$ to punish errors in $\hat{n}$ direction more.
8.  **Solve QP.**
